sap.ui.define(["sap/ui/core/mvc/Controller","sap/m/MessageToast","sap/ui/core/routing/History","sap/ui/model/Filter","sap/ui/model/FilterOperator","rfgundemo/util/Utility","sap/ui/core/Fragment","sap/m/MessagePopover","sap/m/MessageItem","sap/ui/core/Messaging","sap/ui/core/message/Message","sap/ui/core/message/MessageType"],function(e,t,s,r,a,o,i,n,g,u,l,c){"use strict";return e.extend("rfgundemo.controller.DataDetail",{onInit:function(){var e=this;var t=this.getOwnerComponent().getRouter();this.sPurchaseOrderNumber="";e.getView().setBusy(true);t.attachRouteMatched(function(t){var s=t.getParameter("arguments");if(s&&s.purchaseOrderNumber){e.sPurchaseOrderNumber=s.purchaseOrderNumber;e._loadPurchaseOrderData();e._setOrderDetailsTitle()}});this.debounceGoToNextCarouselPage=o.debounce(this._goToNextCarouselPage,300);this.debounceGoToPreviousCarouselPage=o.debounce(this._goToPreviousCarouselPage,300);this._attachInputEventDelegates();this._MessageManager=u;this._MessageManager.removeAllMessages();this.getView().setModel(this._MessageManager.getMessageModel(),"message")},onNavBack:function(){var e=s.getInstance();var t=e.getPreviousHash();if(t!==undefined){window.history.go(-1)}else{var r=this.getOwnerComponent().getRouter();r.navTo("RouteMainScreen",{},true)}},onDownload:function(e){var s=this.getView().getModel();var r=e.getSource();var a=r.getBindingContext();var o=a.getObject();var i="";var n="";var g="";var u=s.bindContext("/ZR_RFH_MIGO_DEMO/com.sap.gateway.srvd_a2x.zui_rf_po_item.v0001.downloadFile(...)");u.setParameter("purchase_order",o.PurchaseOrderNo);u.setParameter("purchase_order_item",o.PurchaseOrderItemNo);u.execute().then(function(){var e=u.getBoundContext();var s=e?e.getObject():null;i=s.fileContent;n=s.mimeType;g=s.fileName;i=i.replace(/\s/g,"");i=i.replace(/-/g,"+").replace(/_/g,"/");var r=atob(i);var a=new Uint8Array(r.length);for(var o=0;o<r.length;o++){a[o]=r.charCodeAt(o)}var l=new Blob([a],{type:n});var c=URL.createObjectURL(l);var d=document.createElement("a");d.href=c;d.download=g;d.style.display="none";d.click();t.show("Download initiated successfully")}.bind(this)).catch(function(e){console.error("Download action failed:",e)});t.show("Download has been initiated for "+g)},onUpload:function(){this.loadFragment({id:"uploadFileDialog",name:"rfgundemo.view.fragments.UploadFileDialog",controller:this}).then(e=>{this.dialog=e;this.dialog.open()})},onCancelPress:function(){this.dialog.close();this.dialog.destroy()},onUploadPress:function(){if(!this.fileContent||!this.fileName){t.show("Please select a file to upload.");return}try{var e=[];var s=this.getView().getModel("device");var r=s.getProperty("/system/phone");if(r){var a=this.byId("orderCarousel");var o=a.getActivePage();var i=a.getPages().find(e=>e.getId()===o);if(i){var n={};var g=i.getItems();n["MaterialDocument"]="";n["PurchaseOrder"]=this.sPurchaseOrderNumber;n["PurchaseOrderItem"]=g[0].getItems()[1].getValue();n["Material"]=g[1].getItems()[0].getItems()[1].getValue();n["MaterialDescription"]=g[1].getItems()[1].getItems()[1].getValue();n["QuantitySuggest"]=parseFloat(g[2].getItems()[0].getItems()[1].getValue()).toFixed(3);n["QuantityReceive"]=parseFloat(g[2].getItems()[1].getItems()[1].getValue()).toFixed(3);n["QuantityUnit"]=g[3].getItems()[1].getValue();n["Plant"]=g[4].getItems()[1].getValue();n["StorageLocation"]=g[5].getItems()[1].getValue();n["ConfirmStatus"]=g[7].getItems()[0].getPressed();n["filename"]=this.fileName;n["filecontent"]=this.fileContent;n["mimetype"]=this.mimeType;n["fileextension"]=this.fileExtension;e.push(n)}}else{var u=this.byId("orderTable");var l=u.getSelectedItems();l.forEach(function(t){var s={};var r=t.getCells();s["MaterialDocument"]="";s["PurchaseOrder"]=this.sPurchaseOrderNumber;s["PurchaseOrderItem"]=r[0].getValue();s["Material"]=r[1].getValue();s["MaterialDescription"]=r[2].getValue();s["QuantitySuggest"]=parseFloat(r[4].getValue()).toFixed(3);s["QuantityReceive"]=parseFloat(r[5].getValue()).toFixed(3);s["QuantityUnit"]=r[6].getValue();s["Plant"]=r[7].getValue();s["StorageLocation"]=r[8].getValue();s["ConfirmStatus"]=r[10].getPressed();s["filename"]=this.fileName;s["filecontent"]=this.fileContent;s["mimetype"]=this.mimeType;s["fileextension"]=this.fileExtension;e.push(s)}.bind(this))}console.log(e);if(e.length===0){t.show("Please select items");return}console.log("Selected Data for Upload:",e);const c=this.getView().getModel();const d=this.getView().getBindingContext();console.log("Binding Context:",d);const h=c.bindContext("/ZR_RFH_MIGO_DEMO/com.sap.gateway.srvd_a2x.zui_rf_po_item.v0001.uploadFile(...)",d);h.setParameter("material_document",e[0].MaterialDocument);h.setParameter("purchase_order",e[0].PurchaseOrder);h.setParameter("purchase_order_item",e[0].PurchaseOrderItem);h.setParameter("fileName",e[0].filename);h.setParameter("fileContent",e[0].filecontent);h.setParameter("mimeType",e[0].mimetype);h.setParameter("fileExtension",e[0].fileextension);h.execute();t.show("File uploaded successfully");this.dialog.close();this.dialog.destroy();c.refresh()}catch(e){console.error("Upload failed:",e);t.show("Upload Failed")}},onFileChange:function(e){const s=e.getParameter("files");if(!s||s.length===0){t.show(this._getText("noFileSelected"));this.resetFileData();return}const r=s[0];this.fileName=r.name;this.mimeType=r.type;const a=r.name.split(".");this.fileExtension=a.length>1?a.pop().toLowerCase():"";const o=new FileReader;o.onload=function(e){const s=e.target.result;this.fileContent=s.split(",")[1];t.show("File loaded successfully: "+r.name)}.bind(this);o.onerror=function(e){console.error("File read error:",e);t.show("Error reading file: "+r.name);this.resetFileData()}.bind(this);o.readAsDataURL(r)},onLiveChangeCheckNumber:function(e){var t=e.getSource();var s=t.getValue();var r=s.replace(/[^0-9]/g,"");t.setValue(r)},onSaveAndPostButtonPress:function(){var e=[];var s=this.getView().getModel("device");var r=s.getProperty("/system/phone");if(r){var a=this.byId("orderCarousel");var o=a.getActivePage();var i=a.getPages().find(e=>e.getId()===o);if(i){var n={};var g=i.getItems();n["MaterialDocument"]="";n["PurchaseOrder"]=this.sPurchaseOrderNumber;n["PurchaseOrderItem"]=g[0].getItems()[1].getValue();n["Material"]=g[1].getItems()[0].getItems()[1].getValue();n["MaterialDescription"]=g[1].getItems()[1].getItems()[1].getValue();n["QuantitySuggest"]=parseFloat(g[2].getItems()[0].getItems()[1].getValue()).toFixed(3);n["QuantityReceive"]=parseFloat(g[2].getItems()[1].getItems()[1].getValue()).toFixed(3);n["QuantityUnit"]=g[3].getItems()[1].getValue();n["Plant"]=g[4].getItems()[1].getValue();n["StorageLocation"]=g[5].getItems()[1].getValue();n["ConfirmStatus"]=g[7].getItems()[0].getPressed();e.push(n);g[2].getItems()[0].getItems()[1].setValue("")}}else{var u=this.byId("orderTable");var l=u.getSelectedItems();l.forEach(function(t){var s={};var r=t.getCells();s["MaterialDocument"]="";s["PurchaseOrder"]=this.sPurchaseOrderNumber;s["PurchaseOrderItem"]=r[0].getValue();s["Material"]=r[1].getValue();s["MaterialDescription"]=r[2].getValue();s["QuantitySuggest"]=parseFloat(r[4].getValue()).toFixed(3);s["QuantityReceive"]=parseFloat(r[5].getValue()).toFixed(3);s["QuantityUnit"]=r[6].getValue();s["Plant"]=r[7].getValue();s["StorageLocation"]=r[8].getValue();s["ConfirmStatus"]=r[10].getPressed();e.push(s);r[5].setValue("")}.bind(this))}if(e.length===0){t.show("Please select items and enter valid quantities");return}this._postToGoodsMovementBAPI(e)},onOkButtonPress:function(e){var t=e.getSource();this._handleToggleButtonState(t);var s=this.byId("orderTable");var r=t.getParent();s.setSelectedItem(r,t.getPressed())},onCarouselPageChanged:function(e){var t=e.getParameter("activePages");var s=this.byId("orderCarousel").getPages()[t];var r=s.getItems()[2].getItems()[1].getItems()[1];if(r){setTimeout(()=>{r.focus()},500)}},onPlantVHRequest:function(e){const t=e.getSource();this._currentPlantInput=t;if(!this._plantVHDialog){this._plantVHDialog=i.load({name:"rfgundemo.view.fragments.PlantVHDialog",controller:this});this.getView().addDependent(this._plantVHDialog)}this._plantVHDialog.open()},onPlantVHConfirm:function(e){const t=e.getParameter("selectedItem");if(t&&this._currentPlantInput){const e=t.getTitle();this._currentPlantInput.setValue(e)}e.getSource().close()},onPlantVHCancel:function(e){e.getSource().close()},onStrLocVHRequest:function(e){const t=e.getSource();this._currentStrLocInput=t;if(!this._strLocVHDialog){this._strLocVHDialog=i.load({name:"rfgundemo.view.fragments.StrLocVHDialog",controller:this});this.getView().addDependent(this._strLocVHDialog)}this._strLocVHDialog.open()},onStrLocVHConfirm:function(e){const t=e.getParameter("selectedItem");if(t&&this._currentStrLocInput){const e=t.getTitle();this._currentStrLocInput.setValue(e)}e.getSource().close()},onStrLocVHCancel:function(e){e.getSource().close()},onShowMessagePopover:function(e){if(!this._oMessagePopover){this._createMessagePopover()}this._oMessagePopover.toggle(e.getSource())},getMessageCount:function(){var e=this._MessageManager.getMessageModel().getData();return e.length||""},getButtonType:function(){var e=this._MessageManager.getMessageModel().getData();var t=e.some(function(e){return e.type==="Error"});var s=e.some(function(e){return e.type==="Warning"});if(t)return"Negative";if(s)return"Critical";return"Neutral"},getButtonIcon:function(){var e=this._MessageManager.getMessageModel().getData();var t=e.some(function(e){return e.type==="Error"});var s=e.some(function(e){return e.type==="Warning"});if(t)return"sap-icon://error";if(s)return"sap-icon://alert";return"sap-icon://information"},_createMessagePopover:function(){this._oMessagePopover=new n({items:{path:"message>/",template:new g({title:"{message>message}",subtitle:"{message>additionalText}",type:"{message>type}",description:"{message>description}"})}});this.getView().addDependent(this._oMessagePopover)},_attachInputEventDelegates:function(){var e=this.byId("dataDetailPage");if(e){e.addEventDelegate({onkeydown:function(e){var t=this.getView().getModel("device");var s=t.getProperty("/system/phone");switch(e.key){case"F3":e.preventDefault();this.onNavBack();break;case"F5":if(s){e.preventDefault();this.debounceGoToNextCarouselPage()}break;case"F6":if(s){e.preventDefault();this.debounceGoToPreviousCarouselPage()}break;case"F7":e.preventDefault();this._triggerOkButtonPress();break;case"F8":e.preventDefault();this.onSaveAndPostButtonPress();break}}.bind(this)})}},_resetAfterSuccessfulPost:function(){const e=this.byId("orderList");e.removeSelections();e.getItems().forEach(function(e){const t=e.getContent()[0];const s=t.getItems();const r=s[4].getItems()[1];r.setValue("");const a=s[9].getItems()[1];a.setPressed(false);a.setIcon("");a.setType("Default")})},_loadPurchaseOrderData:function(){var e=this;var t=this.getView().getModel("device");var s=t.getProperty("/system/phone");var o=[new r("PurchaseOrderNo",a.EQ,this.sPurchaseOrderNumber)];if(s){var i=this.byId("orderCarousel");var n=i.getBinding("pages");n.filter(o);n.attachEventOnce("dataReceived",function(){e.getView().setBusy(false);e._setFocusOnFirstQuantityReceivedInCarousel()})}else{var g=this.byId("orderTable");var n=g.getBinding("items");n.filter(o);g.attachEventOnce("updateFinished",function(){this.getView().setBusy(false);this._setFocusOnFirstQuantityReceived()},this)}},_setFocusOnFirstQuantityReceived:function(){var e=this.byId("orderTable");var t=e.getItems()[0];if(t){t.getCells()[5].focus()}},_setFocusOnFirstQuantityReceivedInCarousel:function(){var e=this.byId("orderCarousel").getPages()[0];var t=e.getItems()[2].getItems()[1].getItems()[1];if(t){setTimeout(()=>{t.focus()},200)}},_setOrderDetailsTitle:function(){var e=this.byId("orderDetailsTitle");if(e){e.setText("Order Details for "+this.sPurchaseOrderNumber)}},_extractStatusCode:function(e){if(e&&e.status){return parseInt(e.status)}if(e&&e.statusCode){return parseInt(e.statusCode)}if(e&&e.error&&e.error.status){return parseInt(e.error.status)}if(e&&e.response&&e.response.status){return parseInt(e.response.status)}if(e&&e.message){var t=e.message.match(/(\d{3})/);if(t){return parseInt(t[1])}}return 0},_postToGoodsMovementBAPI:function(e){var s=this;var r=this.getView().getModel("device");var a=r.getProperty("/system/phone");var o=this.getView().getModel();var i={PurchaseOrder:e[0].PurchaseOrder,item:[...e]};this._MessageManager.removeAllMessages();this.getView().setBusy(true);this._MessageManager.removeAllMessages();this.getView().setBusy(true);try{var n=o.bindContext("/ZR_RFH_MIGO_DEMO/com.sap.gateway.srvd_a2x.zui_rf_po_item.v0001.postBAPI(...)",null);n.setParameter("PurchaseOrder",i.PurchaseOrder);n.setParameter("item",JSON.stringify(i.item));n.execute().then(function(){s.getView().setBusy(false);s._addMessage("Data posted successfully",c.Success,"Document Created","Purchase Order "+i.PurchaseOrder+" has been processed successfully.");if(a){s.byId("orderCarousel").getBinding("pages").refresh();t.show("Data posted successfully")}else{s.byId("orderTable").getBinding("items").refresh()}}).catch(function(e){s.getView().setBusy(false);var t=s._getErrorMessage(e);var r=s._extractStatusCode(e);var a=s._getHttpStatusText(r);s._addMessage("Error posting data",c.Error,a||"Processing Error",t||"An unexpected error occurred during processing.");o.refresh()}).finally(()=>{s._resetAfterSuccessfulPost()})}catch(e){this.getView().setBusy(false);this._addMessage("Error setting up processing",c.Error,"Setup Error",e.message||"Failed to initialize processing.")}},_addMessage:function(e,t,s,r){this._MessageManager.addMessages(new l({message:e,type:t,additionalText:s,description:r,processor:this.getView().getModel()}))},_getErrorMessage:function(e){if(e&&e.message){return e.message}if(e&&e.error&&e.error.message){return e.error.message}if(e&&e.responseText){try{var t=JSON.parse(e.responseText);if(t.error&&t.error.message){return t.error.message}}catch(t){return e.responseText}}return"Unknown error occurred"},_getHttpStatusText:function(e){var t={200:"HTTP 200 - OK",201:"HTTP 201 - Created",400:"HTTP 400 - Bad Request",401:"HTTP 401 - Unauthorized",403:"HTTP 403 - Forbidden",404:"HTTP 404 - Not Found",422:"HTTP 422 - Unprocessable Entity",500:"HTTP 500 - Internal Server Error",502:"HTTP 502 - Bad Gateway",503:"HTTP 503 - Service Unavailable"};return t[e]||"HTTP "+e},_goToNextCarouselPage:function(){var e=this.byId("orderCarousel");var t=e.getPages();var s=e.getActivePage();var r=t.findIndex(e=>e.getId()===s);if(r<t.length-1){var a=t[r+1].getId();e.setActivePage(a)}},_goToPreviousCarouselPage:function(){var e=this.byId("orderCarousel");var t=e.getPages();var s=e.getActivePage();var r=t.findIndex(e=>e.getId()===s);if(r>0){var a=t[r-1].getId();e.setActivePage(a)}},_handleToggleButtonState:function(e){var t=e.getPressed();e.setType(t?"Success":"Emphasized")},_triggerOkButtonPress:function(){var e=this.getView().getModel("device");var t=e.getProperty("/system/phone");if(t){var s=this.byId("orderCarousel");var r=s.getActivePage();var a=s.getPages().find(e=>e.getId()===r);if(a){a.getItems().forEach(e=>{if(e.getItems){e.getItems().forEach(e=>{if(e instanceof sap.m.ToggleButton&&e.getText()==="OK"){e.setPressed(!e.getPressed());this._handleToggleButtonState(e)}})}})}}else{var o=this.byId("orderTable");var i=o.getSelectedItems();if(i.length>0){var n=i[0];var g=n.getCells().find(e=>e instanceof sap.m.ToggleButton&&e.getText()==="OK");if(g){g.setPressed(!g.getPressed());this._handleToggleButtonState(g)}}}}})});
//# sourceMappingURL=DataDetail.controller.js.map